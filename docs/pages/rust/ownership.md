# Rust æ‰€æœ‰æƒç³»ç»Ÿ

æ‰€æœ‰æƒï¼ˆOwnershipï¼‰æ˜¯ Rust æœ€ç‹¬ç‰¹å’Œæ ¸å¿ƒçš„ç‰¹æ€§ï¼Œè®© Rust æ— éœ€åƒåœ¾å›æ”¶å³å¯ä¿è¯å†…å­˜å®‰å…¨ã€‚

## ğŸ“‹ æœ¬ç« å†…å®¹

- [æ‰€æœ‰æƒè§„åˆ™](#æ‰€æœ‰æƒè§„åˆ™)
- [å˜é‡ä½œç”¨åŸŸ](#å˜é‡ä½œç”¨åŸŸ)
- [æ•°æ®äº¤äº’æ–¹å¼](#æ•°æ®äº¤äº’æ–¹å¼)
- [æ‰€æœ‰æƒä¸å‡½æ•°](#æ‰€æœ‰æƒä¸å‡½æ•°)
- [å¼•ç”¨ä¸å€Ÿç”¨](#å¼•ç”¨ä¸å€Ÿç”¨)
- [åˆ‡ç‰‡ç±»å‹](#åˆ‡ç‰‡ç±»å‹)

## æ‰€æœ‰æƒè§„åˆ™

Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶**æ‰€æœ‰è€…ï¼ˆownerï¼‰**çš„å˜é‡ã€‚

### ä¸‰æ¡åŸºæœ¬è§„åˆ™

1. **Rust ä¸­çš„æ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªè¢«ç§°ä¸ºå…¶æ‰€æœ‰è€…çš„å˜é‡**
2. **å€¼åœ¨ä»»ä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…**
3. **å½“æ‰€æœ‰è€…ï¼ˆå˜é‡ï¼‰ç¦»å¼€ä½œç”¨åŸŸï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ**

## å˜é‡ä½œç”¨åŸŸ

```rust
{                      // s åœ¨è¿™é‡Œæ— æ•ˆ, å®ƒå°šæœªå£°æ˜
    let s = "hello";   // ä»æ­¤å¤„èµ·ï¼Œs å¼€å§‹æœ‰æ•ˆ

    // ä½¿ç”¨ s
}                      // æ­¤ä½œç”¨åŸŸå·²ç»“æŸï¼Œs ä¸å†æœ‰æ•ˆ
```

### String ç±»å‹

`String` ç±»å‹ç®¡ç†è¢«åˆ†é…åˆ°å †ä¸Šçš„æ•°æ®ï¼Œå› æ­¤èƒ½å¤Ÿå­˜å‚¨åœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„æ–‡æœ¬ï¼š

```rust
let mut s = String::from("hello");

s.push_str(", world!"); // push_str() åœ¨å­—ç¬¦ä¸²åè¿½åŠ å­—é¢å€¼

println!("{}", s); // å°†æ‰“å° `hello, world!`
```

## æ•°æ®äº¤äº’æ–¹å¼

### æ–¹å¼ä¸€ï¼šç§»åŠ¨ï¼ˆMoveï¼‰

å¯¹äº `String` ç±»å‹ï¼Œä¸ºäº†æ”¯æŒä¸€ä¸ªå¯å˜ã€å¯å¢é•¿çš„æ–‡æœ¬ç‰‡æ®µï¼Œéœ€è¦åœ¨å †ä¸Šåˆ†é…ä¸€å—åœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„å†…å­˜æ¥å­˜æ”¾å†…å®¹ã€‚

```rust
let s1 = String::from("hello");
let s2 = s1;

// println!("{}", s1); // é”™è¯¯ï¼s1 å·²è¢«ç§»åŠ¨
```

**å†…å­˜å¸ƒå±€å›¾ç¤º**ï¼š

![æ ˆå’Œå †çš„å†…å­˜å¸ƒå±€](https://raw.githubusercontent.com/matf5/fileCache/master/20240425163816.png)

å·¦ä¾§ä¸ºæ ˆï¼Œå³ä¾§ä¸ºå †

![ç§»åŠ¨åçš„å†…å­˜çŠ¶æ€](https://raw.githubusercontent.com/matf5/fileCache/master/20240425164109.png)

ç§»åŠ¨ä¹‹ååªæœ‰ `s2` æœ‰æ•ˆï¼Œ`s1` ä¼šè¢«é‡Šæ”¾

**é‡è¦æ¦‚å¿µ**ï¼š
- **é•¿åº¦ï¼ˆLengthï¼‰**ï¼š`String` çš„å†…å®¹å½“å‰ä½¿ç”¨äº†å¤šå°‘å­—èŠ‚çš„å†…å­˜
- **å®¹é‡ï¼ˆCapacityï¼‰**ï¼š`String` ä»åˆ†é…å™¨æ€»å…±è·å–äº†å¤šå°‘å­—èŠ‚çš„å†…å­˜

### æ–¹å¼äºŒï¼šå…‹éš†ï¼ˆCloneï¼‰

å¦‚æœæˆ‘ä»¬**ç¡®å®**éœ€è¦æ·±åº¦å¤åˆ¶ `String` ä¸­å †ä¸Šçš„æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `clone` æ–¹æ³•ï¼š

```rust
let s1 = String::from("hello");
let s2 = s1.clone();

println!("s1 = {}, s2 = {}", s1, s2); // è¿™æ ·å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†
```

### æ–¹å¼ä¸‰ï¼šæ‹·è´ï¼ˆCopyï¼‰

æ ˆä¸Šçš„æ•°æ®å¯ä»¥å¿«é€Ÿå¤åˆ¶ï¼Œå› æ­¤èµ‹å€¼ååŸå˜é‡ä»ç„¶å¯ç”¨ï¼š

```rust
let x = 5;
let y = x;

println!("x = {}, y = {}", x, y); // éƒ½æœ‰æ•ˆ
```

#### Copy trait

å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº† `Copy` traitï¼Œé‚£ä¹ˆä¸€ä¸ªæ—§çš„å˜é‡åœ¨å°†å…¶èµ‹å€¼ç»™å…¶ä»–å˜é‡åä»ç„¶å¯ç”¨ã€‚

**å®ç°äº† `Copy` trait çš„ç±»å‹**ï¼š
- æ‰€æœ‰æ•´æ•°ç±»å‹ï¼Œæ¯”å¦‚ `u32`
- å¸ƒå°”ç±»å‹ï¼Œ`bool`
- æ‰€æœ‰æµ®ç‚¹æ•°ç±»å‹ï¼Œæ¯”å¦‚ `f64`
- å­—ç¬¦ç±»å‹ï¼Œ`char`
- å…ƒç»„ï¼Œå½“ä¸”ä»…å½“å…¶åŒ…å«çš„ç±»å‹ä¹Ÿéƒ½å®ç° `Copy` çš„æ—¶å€™ã€‚æ¯”å¦‚ï¼Œ`(i32, i32)` å®ç°äº† `Copy`ï¼Œä½† `(i32, String)` å°±æ²¡æœ‰

## æ‰€æœ‰æƒä¸å‡½æ•°

å°†å€¼ä¼ é€’ç»™å‡½æ•°åœ¨è¯­ä¹‰ä¸Šä¸ç»™å˜é‡èµ‹å€¼ç›¸ä¼¼ã€‚å‘å‡½æ•°ä¼ é€’å€¼å¯èƒ½ä¼šç§»åŠ¨æˆ–è€…å¤åˆ¶ï¼Œå°±åƒèµ‹å€¼è¯­å¥ä¸€æ ·ã€‚

```rust
fn main() {
    let s = String::from("hello");  // s è¿›å…¥ä½œç”¨åŸŸ

    takes_ownership(s);             // s çš„å€¼ç§»åŠ¨åˆ°å‡½æ•°é‡Œ ...
                                    // ... æ‰€ä»¥åˆ°è¿™é‡Œä¸å†æœ‰æ•ˆ

    let x = 5;                      // x è¿›å…¥ä½œç”¨åŸŸ

    makes_copy(x);                  // x åº”è¯¥ç§»åŠ¨å‡½æ•°é‡Œï¼Œ
                                    // ä½† i32 æ˜¯ Copy çš„ï¼Œæ‰€ä»¥åœ¨åé¢å¯ç»§ç»­ä½¿ç”¨ x

} // è¿™é‡Œ, x å…ˆç§»å‡ºäº†ä½œç”¨åŸŸï¼Œç„¶åæ˜¯ sã€‚ä½†å› ä¸º s çš„å€¼å·²è¢«ç§»èµ°ï¼Œ
  // æ‰€ä»¥ä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ

fn takes_ownership(some_string: String) { // some_string è¿›å…¥ä½œç”¨åŸŸ
    println!("{}", some_string);
} // è¿™é‡Œï¼Œsome_string ç§»å‡ºä½œç”¨åŸŸå¹¶è°ƒç”¨ `drop` æ–¹æ³•ã€‚å ç”¨çš„å†…å­˜è¢«é‡Šæ”¾

fn makes_copy(some_integer: i32) { // some_integer è¿›å…¥ä½œç”¨åŸŸ
    println!("{}", some_integer);
} // è¿™é‡Œï¼Œsome_integer ç§»å‡ºä½œç”¨åŸŸã€‚ä¸ä¼šæœ‰ç‰¹æ®Šæ“ä½œ
```

### è¿”å›å€¼ä¸ä½œç”¨åŸŸ

è¿”å›å€¼ä¹Ÿå¯ä»¥è½¬ç§»æ‰€æœ‰æƒï¼š

```rust
fn main() {
    let s1 = gives_ownership();         // gives_ownership å°†è¿”å›å€¼
                                        // ç§»ç»™ s1

    let s2 = String::from("hello");     // s2 è¿›å…¥ä½œç”¨åŸŸ

    let s3 = takes_and_gives_back(s2);  // s2 è¢«ç§»åŠ¨åˆ°
                                        // takes_and_gives_back ä¸­,
                                        // å®ƒä¹Ÿå°†è¿”å›å€¼ç§»ç»™ s3
} // è¿™é‡Œ, s3 ç§»å‡ºä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒã€‚s2 ä¹Ÿç§»å‡ºä½œç”¨åŸŸï¼Œä½†å·²è¢«ç§»èµ°ï¼Œ
  // æ‰€ä»¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚s1 ç§»å‡ºä½œç”¨åŸŸå¹¶è¢«ä¸¢å¼ƒ

fn gives_ownership() -> String {           // gives_ownership å°†è¿”å›å€¼ç§»åŠ¨ç»™
                                           // è°ƒç”¨å®ƒçš„å‡½æ•°

    let some_string = String::from("yours"); // some_string è¿›å…¥ä½œç”¨åŸŸ

    some_string                              // è¿”å› some_string å¹¶ç§»å‡ºç»™è°ƒç”¨çš„å‡½æ•°
}

// takes_and_gives_back å°†ä¼ å…¥å­—ç¬¦ä¸²å¹¶è¿”å›è¯¥å€¼
fn takes_and_gives_back(a_string: String) -> String { // a_string è¿›å…¥ä½œç”¨åŸŸ

    a_string  // è¿”å› a_string å¹¶ç§»å‡ºç»™è°ƒç”¨çš„å‡½æ•°
}
```

## å¼•ç”¨ä¸å€Ÿç”¨

å¼•ç”¨ï¼ˆreferenceï¼‰åƒä¸€ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç”±æ­¤è®¿é—®å‚¨å­˜äºè¯¥åœ°å€çš„å±äºå…¶ä»–å˜é‡çš„æ•°æ®ã€‚

```rust
fn main() {
    let s1 = String::from("hello");

    let len = calculate_length(&s1);

    println!("The length of '{}' is {}.", s1, len);
}

fn calculate_length(s: &String) -> usize {
    s.len()
}
```

![å¼•ç”¨ç¤ºæ„å›¾](https://raw.githubusercontent.com/matf5/fileCache/master/20240425165744.png)

### å¯å˜å¼•ç”¨

æ­£å¸¸å¼•ç”¨æ˜¯ä¸å¯å˜çš„ï¼Œæ— æ³•é€šè¿‡å¼•ç”¨ä¿®æ”¹å†…å®¹ã€‚å¦‚æœè¦å¯å˜ï¼Œå¯ä»¥ä¿®æ”¹ä¸º `&mut`ï¼š

```rust
fn main() {
    let mut s = String::from("hello");

    change(&mut s);
}

fn change(some_string: &mut String) {
    some_string.push_str(", world");
}
```

### å¯å˜å¼•ç”¨çš„é™åˆ¶

åœ¨åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰ä¸€ä¸ªå¯¹æŸä¸€ç‰¹å®šæ•°æ®çš„å¯å˜å¼•ç”¨ã€‚å°è¯•åˆ›å»ºä¸¤ä¸ªå¯å˜å¼•ç”¨çš„ä»£ç å°†ä¼šå¤±è´¥ï¼š

```rust
let mut s = String::from("hello");

let r1 = &mut s;
let r2 = &mut s; // é”™è¯¯ï¼

println!("{}, {}", r1, r2);
```

ä½†ä»¥ä¸‹ä»£ç æ²¡é—®é¢˜ï¼š

```rust
let mut s = String::from("hello");

let r1 = &s; // æ²¡é—®é¢˜
let r2 = &s; // æ²¡é—®é¢˜
println!("{} and {}", r1, r2);
// æ­¤ä½ç½®ä¹‹å r1 å’Œ r2 ä¸å†ä½¿ç”¨

let r3 = &mut s; // æ²¡é—®é¢˜
println!("{}", r3);
```

### æ‚¬å‚å¼•ç”¨ï¼ˆDangling Referencesï¼‰

æ‚¬å‚å¼•ç”¨æ˜¯æŒ‡å¼•ç”¨äº†ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾çš„å†…å­˜åœ°å€ï¼š

```rust
fn main() {
    let reference_to_nothing = dangle();
}

fn dangle() -> &String { // é”™è¯¯ï¼
    let s = String::from("hello");

    &s // è¿™é‡Œsç¦»å¼€ä½œç”¨åŸŸå·²ç»è¢«é‡Šæ”¾æ‰äº†
}
```

æ­£ç¡®çš„åšæ³•æ˜¯ç›´æ¥è¿”å› `String`ï¼š

```rust
fn no_dangle() -> String {
    let s = String::from("hello");

    s // æ‰€æœ‰æƒè¢«ç§»åŠ¨å‡ºå»ï¼Œæ‰€ä»¥æ²¡æœ‰å€¼è¢«é‡Šæ”¾
}
```

### å¼•ç”¨çš„è§„åˆ™

1. **åœ¨ä»»æ„ç»™å®šæ—¶é—´ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆåªèƒ½æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨**
2. **å¼•ç”¨å¿…é¡»æ€»æ˜¯æœ‰æ•ˆçš„**

### è§£å¼•ç”¨æ“ä½œç¬¦ (*)

```rust
fn main() {
    let x = 5;
    let y = &x;

    assert_eq!(5, x);
    assert_eq!(5, *y); // è§£å¼•ç”¨
}
```

## åˆ‡ç‰‡ç±»å‹

åˆ‡ç‰‡ï¼ˆsliceï¼‰è®©ä½ å¼•ç”¨é›†åˆä¸­ä¸€æ®µè¿ç»­çš„å…ƒç´ åºåˆ—ï¼Œè€Œä¸ç”¨å¼•ç”¨æ•´ä¸ªé›†åˆã€‚

### å­—ç¬¦ä¸²åˆ‡ç‰‡

```rust
let s = String::from("hello world");

let hello = &s[0..5];
let world = &s[6..11];

// è¯­æ³•ç³–
let hello = &s[..5];   // ä»å¼€å§‹åˆ°ç´¢å¼•5
let world = &s[6..];   // ä»ç´¢å¼•6åˆ°ç»“æŸ
let entire = &s[..];   // æ•´ä¸ªå­—ç¬¦ä¸²
```

### å­—ç¬¦ä¸²åˆ‡ç‰‡çš„å®é™…åº”ç”¨

```rust
fn first_word(s: &String) -> &str {
    let bytes = s.as_bytes();

    for (i, &item) in bytes.iter().enumerate() {
        if item == b' ' {
            return &s[0..i];
        }
    }

    &s[..]
}

fn main() {
    let my_string = String::from("hello world");

    // `first_word` æ¥å— `String` çš„åˆ‡ç‰‡ï¼Œæ— è®ºæ˜¯éƒ¨åˆ†è¿˜æ˜¯å…¨éƒ¨
    let word = first_word(&my_string[0..6]);
    let word = first_word(&my_string[..]);
    // `first_word` ä¹Ÿæ¥å— `String` çš„å¼•ç”¨ï¼Œ
    // è¿™ç­‰åŒäº `String` çš„å…¨éƒ¨åˆ‡ç‰‡
    let word = first_word(&my_string);

    let my_string_literal = "hello world";

    // `first_word` æ¥å—å­—ç¬¦ä¸²å­—é¢é‡çš„åˆ‡ç‰‡ï¼Œæ— è®ºæ˜¯éƒ¨åˆ†è¿˜æ˜¯å…¨éƒ¨
    let word = first_word(&my_string_literal[0..6]);
    let word = first_word(&my_string_literal[..]);
    // å­—ç¬¦ä¸²å­—é¢é‡å°±æ˜¯åˆ‡ç‰‡
    let word = first_word(my_string_literal);
}
```

### æ›´å¥½çš„ `first_word` å®ç°

```rust
fn first_word(s: &str) -> &str {
    let bytes = s.as_bytes();

    for (i, &item) in bytes.iter().enumerate() {
        if item == b' ' {
            return &s[0..i];
        }
    }

    &s[..]
}
```

### å…¶ä»–åˆ‡ç‰‡

```rust
let a = [1, 2, 3, 4, 5];

let slice = &a[1..3];

assert_eq!(slice, &[2, 3]);
```

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **æ‰€æœ‰æƒç³»ç»Ÿç¡®ä¿å†…å­˜å®‰å…¨**ï¼šåœ¨ç¼–è¯‘æ—¶é˜²æ­¢æ•°æ®ç«äº‰å’Œå†…å­˜æ³„æ¼
2. **ç§»åŠ¨è¯­ä¹‰æ˜¯é»˜è®¤è¡Œä¸º**ï¼šé¿å…æ„å¤–çš„æ·±æ‹·è´
3. **å€Ÿç”¨æ£€æŸ¥å™¨**ï¼šç¡®ä¿å¼•ç”¨çš„æœ‰æ•ˆæ€§
4. **ç”Ÿå‘½å‘¨æœŸ**ï¼šç¡®ä¿å¼•ç”¨ä¸ä¼šè¶…è¿‡å…¶æŒ‡å‘çš„å€¼
5. **åˆ‡ç‰‡æä¾›å®‰å…¨çš„å±€éƒ¨è®¿é—®**ï¼šæ— éœ€æ‹¥æœ‰æ•´ä¸ªé›†åˆçš„æ‰€æœ‰æƒ

## ğŸ¯ å®è·µå»ºè®®

1. **ä¼˜å…ˆä½¿ç”¨å€Ÿç”¨è€Œéè·å–æ‰€æœ‰æƒ**
2. **æ˜ç¡®åŒºåˆ†å¯å˜å’Œä¸å¯å˜å¼•ç”¨**
3. **åˆ©ç”¨åˆ‡ç‰‡è¿›è¡Œå®‰å…¨çš„åºåˆ—æ“ä½œ**
4. **ç†è§£ç§»åŠ¨è¯­ä¹‰ï¼Œé¿å…åœ¨ç§»åŠ¨åä½¿ç”¨å˜é‡**
5. **å–„ç”¨ `clone()` è¿›è¡Œå¿…è¦çš„æ·±æ‹·è´**

## ğŸ”— ç›¸å…³é“¾æ¥

- **ä¸Šä¸€ç« **: [å·¥å…·ä¸é¡¹ç›®ç®¡ç†](./tools-and-project.md)
- **ä¸‹ä¸€ç« **: [æ•°æ®ç»“æ„](./data-structures.md)
- **ç›¸å…³æ¦‚å¿µ**: [æ³›å‹ä¸ç‰¹å¾](./generics-and-traits.md)

---

[è¿”å›ç´¢å¼•](./index.md) 